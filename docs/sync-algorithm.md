# Sync algorithm and implementation requirements

# Trakt ‚áê Kinopub: –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è **—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö** –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (SPA React)

> –¶–µ–ª—å: –∏–∑ Kinopub –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤ Trakt **—Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ** —Ñ–∏–ª—å–º—ã –∏ —Å–µ—Ä–∏–∏ (—ç–ø–∏–∑–æ–¥—ã).  
> –ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã (progress < 100%, —Å—Ç–∞—Ç—É—Å ‚Äú–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ‚Äù –∏ —Ç.–ø.) **–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è**.  
> –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Trakt **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã**: –µ—Å–ª–∏ —ç—Ç–æ—Ç watch-event —É–∂–µ –µ—Å—Ç—å –≤ Trakt ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.

---

## 0) –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è SPA (React)

### 0.1 Trakt OAuth —Ç—Ä–µ–±—É–µ—Ç `client_secret` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã Trakt –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (device token / refresh token) —Ç—Ä–µ–±—É—é—Ç `client_secret`. –ü–æ—ç—Ç–æ–º—É **—á–∏—Å—Ç—ã–π SPA –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–µ –º–æ–∂–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å OAuth** (—Å–µ–∫—Ä–µ—Ç –Ω–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ).

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ):**
- **SPA** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ UI –∏ —Ä–∞–±–æ—Ç—É —Å Kinopub.
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π **Auth Broker (backend / serverless)** —Ö—Ä–∞–Ω–∏—Ç `TRAKT_CLIENT_SECRET` –∏ –¥–µ–ª–∞–µ—Ç:
  - –æ–±–º–µ–Ω `code -> token` (authorization code flow) **–∏–ª–∏** polling device flow
  - refresh —Ç–æ–∫–µ–Ω–æ–≤
  - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Trakt, –µ—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å `access_token` –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

> –ï—Å–ª–∏ –≤—ã –≤—Å—ë-—Ç–∞–∫–∏ –¥–µ–ª–∞–µ—Ç–µ ‚Äúpure SPA‚Äù, —Ç–æ `client_secret` –Ω–µ–∏–∑–±–µ–∂–Ω–æ –æ–∫–∞–∂–µ—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö/–±–∞–Ω–¥–ª–µ –∏ —Å—Ç–∞–Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º. –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–∏—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ Trakt-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## 1) –¢—Ä–µ–±—É–µ–º—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ —Ç–µ—Ä–º–∏–Ω—ã

### 1.1 Trakt
- `client_id` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `trakt-api-key`).
- `client_secret` ‚Äî —Å–µ–∫—Ä–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–î–û–õ–ñ–ï–ù —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤–Ω–µ SPA).
- `access_token` ‚Äî Bearer-—Ç–æ–∫–µ–Ω –¥–ª—è API –º–µ—Ç–æ–¥–æ–≤ üîí OAuth required.
- `refresh_token` ‚Äî —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `access_token`.
- `expires_in`, `created_at` ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞.

### 1.2 Kinopub (–Ω—É–∂–Ω–æ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äú—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ‚Äù)
- –î–ª—è —Ñ–∏–ª—å–º–∞/—Å–µ—Ä–∏–∞–ª–∞ –Ω—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ‚Äú–≥–ª–æ–±–∞–ª—å–Ω—ã–π‚Äù id:
  - `imdb` **(–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)**, —Ç.–∫. Trakt —É–º–µ–µ—Ç ID lookup –ø–æ IMDB.
  - –µ—Å–ª–∏ `imdb` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≤–æ–∑–º–æ–∂–µ–Ω fallback —á–µ—Ä–µ–∑ text search (—Ö—É–∂–µ).
- –î–ª—è —ç–ø–∏–∑–æ–¥–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
  - `season` (–Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞)
  - `episode` (–Ω–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∑–æ–Ω–∞)

### 1.3 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äú–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞‚Äù
**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–æ–ø—É—Å—Ç–∏–º–∞—è –ª–æ–≥–∏–∫–∞**:
- **–§–∏–ª—å–º**: —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º, –µ—Å–ª–∏ Kinopub –æ—Ç–¥–∞—ë—Ç –µ–≥–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `status=1`) **–∏** (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ) *–≤—Å–µ* –≤–∏–¥–µ–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.
- **–°–µ—Ä–∏–∞–ª / —ç–ø–∏–∑–æ–¥**: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º **—Ç–æ–ª—å–∫–æ —ç–ø–∏–∑–æ–¥—ã**, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `status=1` –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞/–≤–∏–¥–µ–æ).

–ï—Å–ª–∏ Kinopub API –Ω–µ –¥–∞—ë—Ç 100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏ –∏–∑ ‚Äúhistory‚Äù, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/v1/watching` –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º.

---

## 2) –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –∞–Ω—Ç–∏-–¥—É–±–ª–µ–π)

### 2.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤ SPA
–î–ª—è ‚Äú–∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞‚Äù –≤ SPA –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã:
- `sync_state.last_success_at` (UTC ISO 8601) ‚Äî –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
- `sync_state.trakt_user_hash` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Trakt (–º–æ–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å `access_token`/`refresh_token` –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å `slug` –µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ profile).
- –ö—ç—à –º–∞–ø–ø–∏–Ω–≥–∞:
  - `show_imdb -> trakt_show_id`
  - `(trakt_show_id, season) -> { episode_number -> episode_ids }`

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º IndexedDB. localStorage –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ —Ö—É–∂–µ –ø–æ –æ–±—ä—ë–º—É/–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.

### 2.2 –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ Trakt (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
–î–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, **–ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π** –Ω—É–∂–Ω–æ —Å–≤–µ—Ä–∏—Ç—å—Å—è —Å Trakt, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π –ø—Ä–∏:
- —Å–∏–Ω–∫–µ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –æ—á–∏—Å—Ç–∫–µ localStorage/IndexedDB
- –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ö–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ):**
- –î–ª—è —Ñ–∏–ª—å–º–∞: `movie.imdb + watched_at_iso`
- –î–ª—è —ç–ø–∏–∑–æ–¥–∞: `episode.trakt (–∏–ª–∏ tvdb/tmdb) + watched_at_iso`

> –ï—Å–ª–∏ —Ç–æ—á–Ω—ã–π `watched_at` –≤ Kinopub ‚Äú–≥—É–ª—è–µ—Ç‚Äù (—Å–µ–∫—É–Ω–¥—ã/–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã), –Ω–æ—Ä–º–∞–ª–∏–∑—É–π—Ç–µ:
> - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –º–∏–Ω—É—Ç—ã **–∏–ª–∏**
> - `watched_at` ‚Üí `YYYY-MM-DDTHH:MMZ` (–±–µ–∑ —Å–µ–∫—É–Ω–¥).  
> –ü—Ä–∏ —ç—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑ Trakt.

---

## 3) –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: Trakt OAuth (SPA)

–ù–∏–∂–µ –¥–≤–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞. **–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω** –∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–≥–∞–º.

### –í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è SPA): **Device Flow** —á–µ—Ä–µ–∑ Auth Broker

#### A1) SPA: –∑–∞–ø—Ä–æ—Å–∏—Ç—å device codes
1. SPA –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—à Auth Broker: `POST /auth/trakt/device/code`.
2. Auth Broker –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Trakt: `POST https://api.trakt.tv/oauth/device/code`.
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SPA:
   - `user_code`
   - `verification_url` (–æ–±—ã—á–Ω–æ `https://trakt.tv/activate`)
   - `device_code`
   - `interval`
   - `expires_in`

#### A2) SPA: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
–ü–æ–∫–∞–∂–∏—Ç–µ:
- `verification_url`
- `user_code`
–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: UI –¥–æ–ª–∂–µ–Ω —è–≤–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ –∫–æ–¥ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ Trakt.

#### A3) Auth Broker: polling –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å polling: –∫–∞–∂–¥—ã–µ `interval` —Å–µ–∫—É–Ω–¥.
2. –î—ë—Ä–≥–∞—Ç—å `POST https://api.trakt.tv/oauth/device/token` –¥–æ:
   - `200` (—É—Å–ø–µ—Ö) ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
   - `410` (expired) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≤–µ—Ä–Ω—É—Ç—å SPA –æ—à–∏–±–∫—É ‚Äúexpired‚Äù
   - `418` (denied) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≤–µ—Ä–Ω—É—Ç—å SPA ‚Äúdenied‚Äù
   - `429` (slow_down) ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, +5 —Å–µ–∫) –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
   - `404` (invalid) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

#### A4) Auth Broker: –≤—ã–¥–∞—Ç—å —Ç–æ–∫–µ–Ω—ã SPA (–∏–ª–∏ –¥–µ—Ä–∂–∞—Ç—å —É —Å–µ–±—è)
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**: –Ω–µ –æ—Ç–¥–∞–≤–∞—Ç—å `refresh_token` –≤ –±—Ä–∞—É–∑–µ—Ä.  
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
- Auth Broker —Å–æ–∑–¥–∞—ë—Ç `session_id` (HttpOnly cookie) –∏ —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã server-side.
- SPA –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ Auth Broker –∫–∞–∫ –∫ –ø—Ä–æ–∫—Å–∏ –∫ Trakt.

–ï—Å–ª–∏ –±–µ–∑ –ø—Ä–æ–∫—Å–∏ ‚Äî –æ—Ç–¥–∞–π—Ç–µ `access_token`, `refresh_token`, `expires_in`, `created_at` –≤ SPA –∏ —Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –≤ IndexedDB.

#### A5) Refresh
–ü–µ—Ä–µ–¥ –ª—é–±—ã–º Trakt üîí –∑–∞–ø—Ä–æ—Å–æ–º:
- –µ—Å–ª–∏ `now > created_at + expires_in - 60s` ‚Üí refresh —á–µ—Ä–µ–∑ `POST https://api.trakt.tv/oauth/token` (grant_type=refresh_token).

---

### –í–∞—Ä–∏–∞–Ω—Ç B: Authorization Code Flow —á–µ—Ä–µ–∑ Auth Broker (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π redirect)

#### B1) SPA: redirect –Ω–∞ Trakt authorize
–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL:
`https://trakt.tv/oauth/authorize?response_type=code&client_id=...&redirect_uri=...&state=...`
- `state` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (CSRF).
- `redirect_uri` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

#### B2) SPA: callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
1. –ü—Ä–∏–Ω—è—Ç—å `code` –∏ `state` –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
2. –°—Ä–∞–≤–Ω–∏—Ç—å `state` —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º (–∏–Ω–∞—á–µ abort).
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `code` –≤ Auth Broker: `POST /auth/trakt/oauth/exchange`.

#### B3) Auth Broker: exchange `code -> token`
Auth Broker –≤—ã–∑—ã–≤–∞–µ—Ç Trakt token endpoint (—Å—Ç–∞–Ω–¥–∞—Ä—Ç OAuth 2.0):
`POST https://api.trakt.tv/oauth/token`  
Body (–ø—Ä–∏–º–µ—Ä):
```json
{
  "code": "<code_from_callback>",
  "client_id": "<client_id>",
  "client_secret": "<client_secret>",
  "redirect_uri": "<redirect_uri>",
  "grant_type": "authorization_code"
}
```
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –≤–µ—Ä–Ω—É—Ç—å SPA (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ A4).

#### B4) Refresh / revoke ‚Äî –∫–∞–∫ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ A.

---

## 4) –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–∞–ª–≥–æ—Ä–∏—Ç–º –∞–≥–µ–Ω—Ç–∞)

### 4.1 –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
0. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π Trakt `access_token` (refresh –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
1. –ü–æ–ª—É—á–∏—Ç—å –∏–∑ Kinopub —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (history), –Ω–æ **–Ω–µ —Å—á–∏—Ç–∞—Ç—å –µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã** –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏.
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç—å ‚Äúwatching/status‚Äù –≤ Kinopub –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å:
   - –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã –∏ —ç–ø–∏–∑–æ–¥—ã.

–†–µ–∑—É–ª—å—Ç–∞—Ç: `candidateEvents[]`, –≥–¥–µ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç:
- `type`: `"movie"` –∏–ª–∏ `"episode"`
- `watched_at`: UTC ISO 8601 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π)
- `ids`:
  - movie: `{ imdb: "tt..." }` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
  - episode: `{ show_imdb: "tt...", season: N, number: M }` (–Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ)

### 4.2 –ú–∞–ø–ø–∏–Ω–≥ episode -> Trakt episode ids (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
–î–ª—è –∫–∞–∂–¥–æ–≥–æ episode event:
1. –ù–∞–π—Ç–∏ show –≤ Trakt –ø–æ IMDB:
   - `GET /search/imdb/{show_imdb}?type=show`
   - –µ—Å–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí `not_found`, —Å–∫–∏–ø
   - –µ—Å–ª–∏ >1 ‚Üí –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –ø–æ `score` (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ ‚Äî `ambiguous`, —Å–∫–∏–ø
2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —ç–ø–∏–∑–æ–¥–æ–≤ —Å–µ–∑–æ–Ω–∞:
   - `GET /shows/{trakt_show_id}/seasons/{season}?extended=episodes`
3. –ù–∞–π—Ç–∏ —ç–ø–∏–∑–æ–¥ –ø–æ `number`:
   - –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí `episode_not_found`, —Å–∫–∏–ø
4. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å event –≤ —Ñ–æ—Ä–º–∞—Ç Trakt:
   - `ids` ‚Üí episode.ids (trakt/tvdb/tmdb/imdb –µ—Å–ª–∏ –µ—Å—Ç—å)

### 4.3 –î–µ–¥—É–ø: –ø–æ—Å—Ç—Ä–æ–∏—Ç—å remote index –∏–∑ Trakt history
1. –í—ã—á–∏—Å–ª–∏—Ç—å `windowStart`:
   - –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π `last_success_at` ‚Üí `windowStart = last_success_at - 2 days`
   - –∏–Ω–∞—á–µ ‚Üí `windowStart = min(candidateEvents.watched_at) - 2 days`
2. –°–∫–∞—á–∞—Ç—å Trakt watched history:
   - `GET /sync/history/movies?start_at=windowStart&end_at=now`
   - `GET /sync/history/episodes?start_at=windowStart&end_at=now`
   - –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º `X-Pagination-*`
3. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å `remoteKeys` –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º ¬ß2.2

### 4.4 –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏
–î–ª—è –∫–∞–∂–¥–æ–≥–æ `candidateEvent`:
- –≤—ã—á–∏—Å–ª–∏—Ç—å `eventKey`
- –µ—Å–ª–∏ `eventKey ‚àà remoteKeys` ‚Üí **SKIP_DUPLICATE**
- –∏–Ω–∞—á–µ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `toSend[]`

### 4.5 –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Trakt
1. –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å `toSend` –Ω–∞:
   - `movies[]` (–∫–∞–∂–¥—ã–π: `{ids, watched_at}`)
   - `episodes[]` (–∫–∞–∂–¥—ã–π: `{ids, watched_at}`)
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `POST /sync/history` (batched; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ 50, —á—Ç–æ–±—ã –Ω–µ —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç—ã/—Ç–∞–π–º–∞—É—Ç—ã).
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç:
   - `added.*` ‚Äî —Å—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏
   - `not_found.*` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∏–ø–∞—Ç—å –Ω–∞ –±—É–¥—É—â–µ–µ (–±–µ–∑ —Ä–µ—Ç—Ä–∞–µ–≤, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è –º–∞–ø–ø–∏–Ω–≥)

### 4.6 –ö–æ–º–º–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
–ï—Å–ª–∏ –≤—Å–µ –±–∞—Ç—á–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫:
- –∑–∞–ø–∏—Å–∞—Ç—å `sync_state.last_success_at = now_utc`

---

## 5) Edge-case scenarios (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)

### 5.1 OAuth / —Ç–æ–∫–µ–Ω—ã
- `401 Unauthorized` –Ω–∞ Trakt üîí –º–µ—Ç–æ–¥–µ:
  - –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è refresh 1 —Ä–∞–∑
  - –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è ‚Üí re-auth (device flow / redirect)
- `423 Locked User Account`:
  - –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ Trakt support
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ TTL —Ç–æ–∫–µ–Ω–æ–≤:
  - **–Ω–µ** —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å ‚Äú3 –º–µ—Å—è—Ü–∞/24 —á–∞—Å–∞‚Äù
  - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `created_at + expires_in`

### 5.2 Rate limit / –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
- `429`:
  - –∂–¥–∞—Ç—å `Retry-After` —Å–µ–∫—É–Ω–¥, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
- `502/503/504/520/521/522`:
  - exponential backoff (–Ω–∞–ø—Ä–∏–º–µ—Ä 1s, 2s, 4s, 8s; –º–∞–∫—Å–∏–º—É–º 30s) + –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ –ø–æ–ø—ã—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä 5)

### 5.3 –î–∞–Ω–Ω—ã–µ Kinopub
- –ù–µ—Ç `imdb`:
  - fallback: Trakt text search `GET /search/{type}?query=...`
  - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π ‚Üí —Å–∫–∏–ø –∏ –ª–æ–≥ ‚Äúambiguous‚Äù
- –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–æ–≤/—ç–ø–∏–∑–æ–¥–æ–≤:
  - –µ—Å–ª–∏ Kinopub –¥–∞—ë—Ç —Å–µ–∑–æ–Ω/—ç–ø–∏–∑–æ–¥, –∞ Trakt –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ specials (season 0) –∏–ª–∏ –¥—Ä—É–≥–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è ‚Üí —Å–∫–∏–ø
- –í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:
  - –µ—Å–ª–∏ Kinopub –Ω–µ –¥–∞—ë—Ç `watched_at`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, time –∏–∑ history) –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –≤ UTC
  - –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –¥–∞—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `now` –∏ –ø–æ–º–µ—Ç—å—Ç–µ –≤ –ª–æ–≥ –∫–∞–∫ ‚Äútimestamp_missing‚Äù

### 5.4 –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã (rewatch)
–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞: **rewatch —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è**, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è `watched_at` (—Ç.–∫. –∫–ª—é—á –≤–∫–ª—é—á–∞–µ—Ç timestamp).  
–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ ‚Äú—Å—Ç—Ä–æ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —ç–ø–∏–∑–æ–¥/—Ñ–∏–ª—å–º‚Äù ‚Äî –ø–æ–º–µ–Ω—è–π—Ç–µ –∫–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ ‚Äúid-only‚Äù –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º ¬ß2.2/¬ß4.3.

## 8) –ß–µ–∫-–ª–∏—Å—Ç ‚Äú–≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥‚Äù (–¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞)

1. ‚úÖ –£–º–µ–µ—Ç –ø–æ–ª—É—á–∞—Ç—å Trakt tokens (device flow –∏–ª–∏ auth code) **–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è client_secret –≤ SPA**.  
2. ‚úÖ Refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ–¥ –ª—é–±—ã–º üîí –≤—ã–∑–æ–≤–æ–º.  
3. ‚úÖ –ò–∑ Kinopub —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **completed** –ø—Ä–æ—Å–º–æ—Ç—Ä—ã.  
4. ‚úÖ Episode mapping —á–µ—Ä–µ–∑ IMDB —à–æ—É + seasons endpoint.  
5. ‚úÖ –ü–µ—Ä–µ–¥ POST `/sync/history` —Å—Ç—Ä–æ–∏—Ç—Å—è remote index —á–µ—Ä–µ–∑ GET `/sync/history/*`.  
6. ‚úÖ –î–µ–¥—É–ø (skip duplicates) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–ª—é—á–∞–º ¬ß2.2.  
7. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã rate limits –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (—Ä–µ—Ç—Ä–∞–∏).  
8. ‚úÖ `last_success_at` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –±–∞—Ç—á–µ–π.
