You are developing a react web app for one way sync of watch history from Kinopub to Trakt. 

# Trakt ‚áê Kinopub: –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è **—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö** –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (SPA React)

> –¶–µ–ª—å: –∏–∑ Kinopub –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤ Trakt **—Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ** —Ñ–∏–ª—å–º—ã –∏ —Å–µ—Ä–∏–∏ (—ç–ø–∏–∑–æ–¥—ã).  
> –ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã (progress < 100%, —Å—Ç–∞—Ç—É—Å ‚Äú–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ‚Äù –∏ —Ç.–ø.) **–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è**.  
> –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Trakt **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã**: –µ—Å–ª–∏ —ç—Ç–æ—Ç watch-event —É–∂–µ –µ—Å—Ç—å –≤ Trakt ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.

---

## 0) –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è SPA (React)

### 0.1 Trakt OAuth —Ç—Ä–µ–±—É–µ—Ç `client_secret` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã Trakt –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (device token / refresh token) —Ç—Ä–µ–±—É—é—Ç `client_secret`. –ü–æ—ç—Ç–æ–º—É **—á–∏—Å—Ç—ã–π SPA –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–µ –º–æ–∂–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å OAuth** (—Å–µ–∫—Ä–µ—Ç –Ω–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ).

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ):**
- **SPA** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ UI –∏ —Ä–∞–±–æ—Ç—É —Å Kinopub.
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π **Auth Broker (backend / serverless)** —Ö—Ä–∞–Ω–∏—Ç `TRAKT_CLIENT_SECRET` –∏ –¥–µ–ª–∞–µ—Ç:
  - –æ–±–º–µ–Ω `code -> token` (authorization code flow) **–∏–ª–∏** polling device flow
  - refresh —Ç–æ–∫–µ–Ω–æ–≤
  - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Trakt, –µ—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å `access_token` –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

> –ï—Å–ª–∏ –≤—ã –≤—Å—ë-—Ç–∞–∫–∏ –¥–µ–ª–∞–µ—Ç–µ ‚Äúpure SPA‚Äù, —Ç–æ `client_secret` –Ω–µ–∏–∑–±–µ–∂–Ω–æ –æ–∫–∞–∂–µ—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö/–±–∞–Ω–¥–ª–µ –∏ —Å—Ç–∞–Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º. –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–∏—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ Trakt-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## 1) –¢—Ä–µ–±—É–µ–º—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ —Ç–µ—Ä–º–∏–Ω—ã

### 1.1 Trakt
- `client_id` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `trakt-api-key`).
- `client_secret` ‚Äî —Å–µ–∫—Ä–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–î–û–õ–ñ–ï–ù —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤–Ω–µ SPA).
- `access_token` ‚Äî Bearer-—Ç–æ–∫–µ–Ω –¥–ª—è API –º–µ—Ç–æ–¥–æ–≤ üîí OAuth required.
- `refresh_token` ‚Äî —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `access_token`.
- `expires_in`, `created_at` ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞.

### 1.2 Kinopub (–Ω—É–∂–Ω–æ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äú—Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ‚Äù)
- –î–ª—è —Ñ–∏–ª—å–º–∞/—Å–µ—Ä–∏–∞–ª–∞ –Ω—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ‚Äú–≥–ª–æ–±–∞–ª—å–Ω—ã–π‚Äù id:
  - `imdb` **(–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)**, —Ç.–∫. Trakt —É–º–µ–µ—Ç ID lookup –ø–æ IMDB.
  - –µ—Å–ª–∏ `imdb` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≤–æ–∑–º–æ–∂–µ–Ω fallback —á–µ—Ä–µ–∑ text search (—Ö—É–∂–µ).
- –î–ª—è —ç–ø–∏–∑–æ–¥–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
  - `season` (–Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞)
  - `episode` (–Ω–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∑–æ–Ω–∞)

### 1.3 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äú–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞‚Äù
**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–æ–ø—É—Å—Ç–∏–º–∞—è –ª–æ–≥–∏–∫–∞**:
- **–§–∏–ª—å–º**: —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º, –µ—Å–ª–∏ Kinopub –æ—Ç–¥–∞—ë—Ç –µ–≥–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `status=1`) **–∏** (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ) *–≤—Å–µ* –≤–∏–¥–µ–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.
- **–°–µ—Ä–∏–∞–ª / —ç–ø–∏–∑–æ–¥**: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º **—Ç–æ–ª—å–∫–æ —ç–ø–∏–∑–æ–¥—ã**, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `status=1` –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞/–≤–∏–¥–µ–æ).

–ï—Å–ª–∏ Kinopub API –Ω–µ –¥–∞—ë—Ç 100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏ –∏–∑ ‚Äúhistory‚Äù, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/v1/watching` –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º.

---

## 2) –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –∞–Ω—Ç–∏-–¥—É–±–ª–µ–π)

### 2.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤ SPA
–î–ª—è ‚Äú–∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞‚Äù –≤ SPA –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã:
- `sync_state.last_success_at` (UTC ISO 8601) ‚Äî –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
- `sync_state.trakt_user_hash` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Trakt (–º–æ–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å `access_token`/`refresh_token` –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å `slug` –µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ profile).
- –ö—ç—à –º–∞–ø–ø–∏–Ω–≥–∞:
  - `show_imdb -> trakt_show_id`
  - `(trakt_show_id, season) -> { episode_number -> episode_ids }`

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º IndexedDB. localStorage –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ —Ö—É–∂–µ –ø–æ –æ–±—ä—ë–º—É/–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.

### 2.2 –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ Trakt (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
–î–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, **–ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π** –Ω—É–∂–Ω–æ —Å–≤–µ—Ä–∏—Ç—å—Å—è —Å Trakt, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π –ø—Ä–∏:
- —Å–∏–Ω–∫–µ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –æ—á–∏—Å—Ç–∫–µ localStorage/IndexedDB
- –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ö–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ):**
- –î–ª—è —Ñ–∏–ª—å–º–∞: `movie.imdb + watched_at_iso`
- –î–ª—è —ç–ø–∏–∑–æ–¥–∞: `episode.trakt (–∏–ª–∏ tvdb/tmdb) + watched_at_iso`

> –ï—Å–ª–∏ —Ç–æ—á–Ω—ã–π `watched_at` –≤ Kinopub ‚Äú–≥—É–ª—è–µ—Ç‚Äù (—Å–µ–∫—É–Ω–¥—ã/–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã), –Ω–æ—Ä–º–∞–ª–∏–∑—É–π—Ç–µ:
> - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –º–∏–Ω—É—Ç—ã **–∏–ª–∏**
> - `watched_at` ‚Üí `YYYY-MM-DDTHH:MMZ` (–±–µ–∑ —Å–µ–∫—É–Ω–¥).  
> –ü—Ä–∏ —ç—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑ Trakt.

---

## 3) –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: Trakt OAuth (SPA)

–ù–∏–∂–µ –¥–≤–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞. **–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω** –∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–≥–∞–º.

### –í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è SPA): **Device Flow** —á–µ—Ä–µ–∑ Auth Broker

#### A1) SPA: –∑–∞–ø—Ä–æ—Å–∏—Ç—å device codes
1. SPA –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—à Auth Broker: `POST /auth/trakt/device/code`.
2. Auth Broker –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Trakt: `POST https://api.trakt.tv/oauth/device/code`.
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SPA:
   - `user_code`
   - `verification_url` (–æ–±—ã—á–Ω–æ `https://trakt.tv/activate`)
   - `device_code`
   - `interval`
   - `expires_in`

#### A2) SPA: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
–ü–æ–∫–∞–∂–∏—Ç–µ:
- `verification_url`
- `user_code`
–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: UI –¥–æ–ª–∂–µ–Ω —è–≤–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ –∫–æ–¥ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ Trakt.

#### A3) Auth Broker: polling –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å polling: –∫–∞–∂–¥—ã–µ `interval` —Å–µ–∫—É–Ω–¥.
2. –î—ë—Ä–≥–∞—Ç—å `POST https://api.trakt.tv/oauth/device/token` –¥–æ:
   - `200` (—É—Å–ø–µ—Ö) ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
   - `410` (expired) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≤–µ—Ä–Ω—É—Ç—å SPA –æ—à–∏–±–∫—É ‚Äúexpired‚Äù
   - `418` (denied) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≤–µ—Ä–Ω—É—Ç—å SPA ‚Äúdenied‚Äù
   - `429` (slow_down) ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, +5 —Å–µ–∫) –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
   - `404` (invalid) ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

#### A4) Auth Broker: –≤—ã–¥–∞—Ç—å —Ç–æ–∫–µ–Ω—ã SPA (–∏–ª–∏ –¥–µ—Ä–∂–∞—Ç—å —É —Å–µ–±—è)
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**: –Ω–µ –æ—Ç–¥–∞–≤–∞—Ç—å `refresh_token` –≤ –±—Ä–∞—É–∑–µ—Ä.  
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
- Auth Broker —Å–æ–∑–¥–∞—ë—Ç `session_id` (HttpOnly cookie) –∏ —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã server-side.
- SPA –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ Auth Broker –∫–∞–∫ –∫ –ø—Ä–æ–∫—Å–∏ –∫ Trakt.

–ï—Å–ª–∏ –±–µ–∑ –ø—Ä–æ–∫—Å–∏ ‚Äî –æ—Ç–¥–∞–π—Ç–µ `access_token`, `refresh_token`, `expires_in`, `created_at` –≤ SPA –∏ —Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –≤ IndexedDB.

#### A5) Refresh
–ü–µ—Ä–µ–¥ –ª—é–±—ã–º Trakt üîí –∑–∞–ø—Ä–æ—Å–æ–º:
- –µ—Å–ª–∏ `now > created_at + expires_in - 60s` ‚Üí refresh —á–µ—Ä–µ–∑ `POST https://api.trakt.tv/oauth/token` (grant_type=refresh_token).

---

### –í–∞—Ä–∏–∞–Ω—Ç B: Authorization Code Flow —á–µ—Ä–µ–∑ Auth Broker (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π redirect)

#### B1) SPA: redirect –Ω–∞ Trakt authorize
–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL:
`https://trakt.tv/oauth/authorize?response_type=code&client_id=...&redirect_uri=...&state=...`
- `state` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (CSRF).
- `redirect_uri` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

#### B2) SPA: callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
1. –ü—Ä–∏–Ω—è—Ç—å `code` –∏ `state` –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
2. –°—Ä–∞–≤–Ω–∏—Ç—å `state` —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º (–∏–Ω–∞—á–µ abort).
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `code` –≤ Auth Broker: `POST /auth/trakt/oauth/exchange`.

#### B3) Auth Broker: exchange `code -> token`
Auth Broker –≤—ã–∑—ã–≤–∞–µ—Ç Trakt token endpoint (—Å—Ç–∞–Ω–¥–∞—Ä—Ç OAuth 2.0):
`POST https://api.trakt.tv/oauth/token`  
Body (–ø—Ä–∏–º–µ—Ä):
```json
{
  "code": "<code_from_callback>",
  "client_id": "<client_id>",
  "client_secret": "<client_secret>",
  "redirect_uri": "<redirect_uri>",
  "grant_type": "authorization_code"
}
```
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –≤–µ—Ä–Ω—É—Ç—å SPA (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ A4).

#### B4) Refresh / revoke ‚Äî –∫–∞–∫ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ A.

---

## 4) –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–∞–ª–≥–æ—Ä–∏—Ç–º –∞–≥–µ–Ω—Ç–∞)

### 4.1 –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
0. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π Trakt `access_token` (refresh –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
1. –ü–æ–ª—É—á–∏—Ç—å –∏–∑ Kinopub —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (history), –Ω–æ **–Ω–µ —Å—á–∏—Ç–∞—Ç—å –µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã** –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏.
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç—å ‚Äúwatching/status‚Äù –≤ Kinopub –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å:
   - –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã –∏ —ç–ø–∏–∑–æ–¥—ã.

–†–µ–∑—É–ª—å—Ç–∞—Ç: `candidateEvents[]`, –≥–¥–µ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç:
- `type`: `"movie"` –∏–ª–∏ `"episode"`
- `watched_at`: UTC ISO 8601 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π)
- `ids`:
  - movie: `{ imdb: "tt..." }` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
  - episode: `{ show_imdb: "tt...", season: N, number: M }` (–Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ)

### 4.2 –ú–∞–ø–ø–∏–Ω–≥ episode -> Trakt episode ids (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
–î–ª—è –∫–∞–∂–¥–æ–≥–æ episode event:
1. –ù–∞–π—Ç–∏ show –≤ Trakt –ø–æ IMDB:
   - `GET /search/imdb/{show_imdb}?type=show`
   - –µ—Å–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí `not_found`, —Å–∫–∏–ø
   - –µ—Å–ª–∏ >1 ‚Üí –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –ø–æ `score` (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ ‚Äî `ambiguous`, —Å–∫–∏–ø
2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —ç–ø–∏–∑–æ–¥–æ–≤ —Å–µ–∑–æ–Ω–∞:
   - `GET /shows/{trakt_show_id}/seasons/{season}?extended=episodes`
3. –ù–∞–π—Ç–∏ —ç–ø–∏–∑–æ–¥ –ø–æ `number`:
   - –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí `episode_not_found`, —Å–∫–∏–ø
4. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å event –≤ —Ñ–æ—Ä–º–∞—Ç Trakt:
   - `ids` ‚Üí episode.ids (trakt/tvdb/tmdb/imdb –µ—Å–ª–∏ –µ—Å—Ç—å)

### 4.3 –î–µ–¥—É–ø: –ø–æ—Å—Ç—Ä–æ–∏—Ç—å remote index –∏–∑ Trakt history
1. –í—ã—á–∏—Å–ª–∏—Ç—å `windowStart`:
   - –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π `last_success_at` ‚Üí `windowStart = last_success_at - 2 days`
   - –∏–Ω–∞—á–µ ‚Üí `windowStart = min(candidateEvents.watched_at) - 2 days`
2. –°–∫–∞—á–∞—Ç—å Trakt watched history:
   - `GET /sync/history/movies?start_at=windowStart&end_at=now`
   - `GET /sync/history/episodes?start_at=windowStart&end_at=now`
   - –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º `X-Pagination-*`
3. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å `remoteKeys` –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º ¬ß2.2

### 4.4 –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏
–î–ª—è –∫–∞–∂–¥–æ–≥–æ `candidateEvent`:
- –≤—ã—á–∏—Å–ª–∏—Ç—å `eventKey`
- –µ—Å–ª–∏ `eventKey ‚àà remoteKeys` ‚Üí **SKIP_DUPLICATE**
- –∏–Ω–∞—á–µ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `toSend[]`

### 4.5 –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Trakt
1. –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å `toSend` –Ω–∞:
   - `movies[]` (–∫–∞–∂–¥—ã–π: `{ids, watched_at}`)
   - `episodes[]` (–∫–∞–∂–¥—ã–π: `{ids, watched_at}`)
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `POST /sync/history` (batched; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ 50, —á—Ç–æ–±—ã –Ω–µ —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç—ã/—Ç–∞–π–º–∞—É—Ç—ã).
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç:
   - `added.*` ‚Äî —Å—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏
   - `not_found.*` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∏–ø–∞—Ç—å –Ω–∞ –±—É–¥—É—â–µ–µ (–±–µ–∑ —Ä–µ—Ç—Ä–∞–µ–≤, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è –º–∞–ø–ø–∏–Ω–≥)

### 4.6 –ö–æ–º–º–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
–ï—Å–ª–∏ –≤—Å–µ –±–∞—Ç—á–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫:
- –∑–∞–ø–∏—Å–∞—Ç—å `sync_state.last_success_at = now_utc`

---

## 5) Edge-case scenarios (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)

### 5.1 OAuth / —Ç–æ–∫–µ–Ω—ã
- `401 Unauthorized` –Ω–∞ Trakt üîí –º–µ—Ç–æ–¥–µ:
  - –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è refresh 1 —Ä–∞–∑
  - –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è ‚Üí re-auth (device flow / redirect)
- `423 Locked User Account`:
  - –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ Trakt support
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ TTL —Ç–æ–∫–µ–Ω–æ–≤:
  - **–Ω–µ** —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å ‚Äú3 –º–µ—Å—è—Ü–∞/24 —á–∞—Å–∞‚Äù
  - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `created_at + expires_in`

### 5.2 Rate limit / –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
- `429`:
  - –∂–¥–∞—Ç—å `Retry-After` —Å–µ–∫—É–Ω–¥, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
- `502/503/504/520/521/522`:
  - exponential backoff (–Ω–∞–ø—Ä–∏–º–µ—Ä 1s, 2s, 4s, 8s; –º–∞–∫—Å–∏–º—É–º 30s) + –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ –ø–æ–ø—ã—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä 5)

### 5.3 –î–∞–Ω–Ω—ã–µ Kinopub
- –ù–µ—Ç `imdb`:
  - fallback: Trakt text search `GET /search/{type}?query=...`
  - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π ‚Üí —Å–∫–∏–ø –∏ –ª–æ–≥ ‚Äúambiguous‚Äù
- –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–æ–≤/—ç–ø–∏–∑–æ–¥–æ–≤:
  - –µ—Å–ª–∏ Kinopub –¥–∞—ë—Ç —Å–µ–∑–æ–Ω/—ç–ø–∏–∑–æ–¥, –∞ Trakt –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ specials (season 0) –∏–ª–∏ –¥—Ä—É–≥–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è ‚Üí —Å–∫–∏–ø
- –í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:
  - –µ—Å–ª–∏ Kinopub –Ω–µ –¥–∞—ë—Ç `watched_at`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, time –∏–∑ history) –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –≤ UTC
  - –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –¥–∞—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `now` –∏ –ø–æ–º–µ—Ç—å—Ç–µ –≤ –ª–æ–≥ –∫–∞–∫ ‚Äútimestamp_missing‚Äù

### 5.4 –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã (rewatch)
–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞: **rewatch —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è**, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è `watched_at` (—Ç.–∫. –∫–ª—é—á –≤–∫–ª—é—á–∞–µ—Ç timestamp).  
–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ ‚Äú—Å—Ç—Ä–æ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —ç–ø–∏–∑–æ–¥/—Ñ–∏–ª—å–º‚Äù ‚Äî –ø–æ–º–µ–Ω—è–π—Ç–µ –∫–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ ‚Äúid-only‚Äù –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º ¬ß2.2/¬ß4.3.

---

## 6) –¢—Ä–µ–±—É–µ–º—ã–µ Trakt —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ø–æ–¥—Ä–æ–±–Ω–æ)

> –ë–∞–∑–æ–≤—ã–π URL API: `https://api.trakt.tv`  
> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
> - `Content-Type: application/json`
> - `trakt-api-key: <client_id>`
> - `trakt-api-version: 2`
> - `Authorization: Bearer <access_token>` (–¥–ª—è üîí –º–µ—Ç–æ–¥–æ–≤)

### 6.1 Authentication

#### 6.1.1 POST `/oauth/device/code` (device flow ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥—ã)
**Body**
```json
{ "client_id": "<client_id>" }
```

**Response 200**
```json
{
  "device_code": "....",
  "user_code": "5055CC52",
  "verification_url": "https://trakt.tv/activate",
  "expires_in": 600,
  "interval": 5
}
```

---

#### 6.1.2 POST `/oauth/device/token` (device flow ‚Äî polling —Ç–æ–∫–µ–Ω–∞)
**Body**
```json
{
  "code": "<device_code>",
  "client_id": "<client_id>",
  "client_secret": "<client_secret>"
}
```

**Response 200**
```json
{
  "access_token": "....",
  "token_type": "bearer",
  "expires_in": 7200,
  "refresh_token": "....",
  "scope": "public",
  "created_at": 1487889741
}
```

**–û—à–∏–±–∫–∏**: `400 pending`, `404 invalid`, `409 already_used`, `410 expired`, `418 denied`, `429 slow_down`.

---

#### 6.1.3 POST `/oauth/token` (refresh access_token)
**Body**
```json
{
  "refresh_token": "<refresh_token>",
  "client_id": "<client_id>",
  "client_secret": "<client_secret>",
  "redirect_uri": "<redirect_uri>",
  "grant_type": "refresh_token"
}
```

**Response 200**
```json
{
  "access_token": "....",
  "token_type": "bearer",
  "expires_in": 7200,
  "refresh_token": "....",
  "scope": "public",
  "created_at": 1487889741
}
```

> –≠—Ç–∏–º –∂–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –æ–±—ã—á–Ω–æ –¥–µ–ª–∞—é—Ç –∏ exchange `authorization_code` (grant_type=authorization_code), –Ω–æ –≤ Trakt —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π OAuth 2.0.

---

#### 6.1.4 POST `/oauth/revoke` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: logout)
**Body**
```json
{
  "token": "<access_token>",
  "client_id": "<client_id>",
  "client_secret": "<client_secret>"
}
```

**Response 200**
```json
{}
```

---

### 6.2 ID lookup / –ø–æ–∏—Å–∫ (–¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ Kinopub -> Trakt)

#### 6.2.1 GET `/search/imdb/{id}?type=movie|show|episode`
- `{id}`: –Ω–∞–ø—Ä–∏–º–µ—Ä `tt1104001`
- `type`: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–¥–ª—è IMDB –ª—É—á—à–µ —É–∫–∞–∑—ã–≤–∞—Ç—å)

**Response 200 (–ø—Ä–∏–º–µ—Ä movie)**
```json
[
  {
    "type": "movie",
    "score": null,
    "movie": {
      "title": "TRON: Legacy",
      "year": 2010,
      "ids": { "trakt": 12601, "slug": "tron-legacy-2010", "imdb": "tt1104001", "tmdb": 20526 }
    }
  }
]
```

---

#### 6.2.2 GET `/search/{type}?query=...` (fallback text search)
- `{type}`: `movie` –∏–ª–∏ `show`
- `query`: —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ (title)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç IMDB/TMDB/TVDB id.

---

### 6.3 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —ç–ø–∏–∑–æ–¥–æ–≤ (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å episode ids)

#### 6.3.1 GET `/shows/{id}/seasons/{season}?extended=episodes`
- `{id}`: Trakt ID –∏–ª–∏ slug —à–æ—É
- `{season}`: –Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞
- `extended=episodes`: —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å —ç–ø–∏–∑–æ–¥—ã —Å `ids`

**Response 200 (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä)**
```json
[
  {
    "number": 1,
    "episodes": [
      {
        "season": 1,
        "number": 1,
        "title": "Winter Is Coming",
        "ids": { "trakt": 36440, "tvdb": 3254641, "tmdb": 63056, "imdb": "tt1480055" }
      }
    ]
  }
]
```

---

### 6.4 Sync: —á—Ç–µ–Ω–∏–µ history (–¥–ª—è –¥–µ–¥—É–ø–∞)

#### 6.4.1 GET `/sync/last_activities`
–ü–æ–ª–µ–∑–Ω–æ, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –º–µ–Ω—è–ª–∞—Å—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—è —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è).  
**OAuth required**.

**Response 200**: –æ–±—ä–µ–∫—Ç —Å `movies.watched_at`, `episodes.watched_at` –∏ —Ç.–ø.

---

#### 6.4.2 GET `/sync/history/{type}?start_at=...&end_at=...`
- `{type}`: `movies` –∏–ª–∏ `episodes`
- `start_at`, `end_at`: UTC ISO 8601
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∏:
  - `X-Pagination-Page`, `X-Pagination-Page-Count`, `X-Pagination-Limit`, `X-Pagination-Item-Count`

**Response 200 (–ø—Ä–∏–º–µ—Ä episodes, —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π)**
```json
[
  {
    "id": 1982346,
    "watched_at": "2014-03-31T09:28:53.000Z",
    "action": "watch",
    "type": "episode",
    "episode": {
      "season": 2,
      "number": 1,
      "title": "Pawnee Zoo",
      "ids": { "trakt": 251, "tvdb": 797571, "tmdb": 397629, "imdb": null }
    },
    "show": {
      "title": "Parks and Recreation",
      "year": 2009,
      "ids": { "trakt": 4, "tvdb": 84912, "tmdb": 8592, "imdb": "tt1266020", "slug": "parks-and-recreation" }
    }
  }
]
```

---

### 6.5 Sync: –∑–∞–ø–∏—Å—å history (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

#### 6.5.1 POST `/sync/history`
–î–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.  
**OAuth required**.

**Body (–ø—Ä–∏–º–µ—Ä: 1 movie + 1 episode)**
```json
{
  "movies": [
    { "ids": { "imdb": "tt0372784" }, "watched_at": "2014-09-01T09:10:11.000Z" }
  ],
  "episodes": [
    { "ids": { "trakt": 1061 }, "watched_at": "2014-09-01T09:10:11.000Z" }
  ]
}
```

**Response 201**
```json
{
  "added": { "movies": 1, "episodes": 1 },
  "not_found": { "movies": [], "episodes": [] }
}
```

---

## 7) –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ Trakt —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è –∑–∞–¥–∞—á–∏

### OAuth
- `POST /oauth/device/code`
- `POST /oauth/device/token`
- `POST /oauth/token` (refresh)
- `POST /oauth/revoke` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `GET https://trakt.tv/oauth/authorize` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ authorization code flow)

### –ú–∞–ø–ø–∏–Ω–≥
- `GET /search/imdb/{id}?type=movie|show`
- `GET /shows/{id}/seasons/{season}?extended=episodes`

### –î–µ–¥—É–ø + –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏
- `GET /sync/history/movies`
- `GET /sync/history/episodes`
- `POST /sync/history`
- `GET /sync/last_activities` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

---

## 8) –ß–µ–∫-–ª–∏—Å—Ç ‚Äú–≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥‚Äù (–¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞)

1. ‚úÖ –£–º–µ–µ—Ç –ø–æ–ª—É—á–∞—Ç—å Trakt tokens (device flow –∏–ª–∏ auth code) **–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è client_secret –≤ SPA**.  
2. ‚úÖ Refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ–¥ –ª—é–±—ã–º üîí –≤—ã–∑–æ–≤–æ–º.  
3. ‚úÖ –ò–∑ Kinopub —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **completed** –ø—Ä–æ—Å–º–æ—Ç—Ä—ã.  
4. ‚úÖ Episode mapping —á–µ—Ä–µ–∑ IMDB —à–æ—É + seasons endpoint.  
5. ‚úÖ –ü–µ—Ä–µ–¥ POST `/sync/history` —Å—Ç—Ä–æ–∏—Ç—Å—è remote index —á–µ—Ä–µ–∑ GET `/sync/history/*`.  
6. ‚úÖ –î–µ–¥—É–ø (skip duplicates) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–ª—é—á–∞–º ¬ß2.2.  
7. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã rate limits –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (—Ä–µ—Ç—Ä–∞–∏).  
8. ‚úÖ `last_success_at` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –±–∞—Ç—á–µ–π.

# KinoAPI: —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (movies/serials/episodes)

–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–±—Ä–∞–Ω –ø–æ –ø—É–±–ª–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ KinoAPI –∏ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è:

- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤)
- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏/—Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ (—Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã, —ç–ø–∏–∑–æ–¥—ã)
- –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∏–ª—å–º–∞–º/—Å–µ—Ä–∏–∞–ª–∞–º (–Ω–∞–∑–≤–∞–Ω–∏—è, –ø–æ—Å—Ç–µ—Ä—ã, imdb –∏ –¥—Ä. –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã)

---

## 0) –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å API

### –ë–∞–∑–æ–≤—ã–π URL
`https://api.service-kp.com`

### –ö–∞–∫ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å access_token –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- –î–ª—è **GET** –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ query-–ø–∞—Ä–∞–º–µ—Ç—Ä: `?access_token=...`
- –î–ª—è **POST** –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ–º–∏–º–æ `access_token` –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å cookie –∏ CSRF-—Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –≤–∞—à –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ cookie-jar, –∑–∞–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Ç–æ, —á—Ç–æ —á–∞—Å—Ç—å POST-–º–µ—Ç–æ–¥–æ–≤ –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å ‚Äú–Ω–∞—Å—Ç–æ—è—â—É—é‚Äù –±—Ä–∞—É–∑–µ—Ä–Ω—É—é —Å–µ—Å—Å–∏—é).

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è ‚Äú—á–∏—Å—Ç–æ–≥–æ‚Äù API-–∫–ª–∏–µ–Ω—Ç–∞:
1) –¥–µ—Ä–∂–∏—Ç–µ `access_token` –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –µ–≥–æ –≤ query,
2) –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è POST-–º–µ—Ç–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/v1/device/notify`), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTP-–∫–ª–∏–µ–Ω—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π cookie-jar.

---

## 1) –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (OAuth Device Flow) –∏ —Ç–æ–∫–µ–Ω—ã

> –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `client_id` –∏ `client_secret` –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.  
> –ü–æ—Ç–æ–∫ ‚Äî OAuth Device Flow: —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—É—á–∞–µ—Ç `user_code`, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –µ–≥–æ –Ω–∞ —Å–∞–π—Ç–µ, –∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Äú–ø—É–ª–ª–∏—Ç‚Äù —Ç–æ–∫–µ–Ω.

### 1.1 –ü–æ–ª—É—á–µ–Ω–∏–µ `device_code`
**POST** `/oauth2/device`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `grant_type` = `device_code` (–æ–±—è–∑.)
- `client_id` (–æ–±—è–∑.)
- `client_secret` (–æ–±—è–∑.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
POST https://api.service-kp.com/oauth2/device?grant_type=device_code&client_id=myclient&client_secret=mysecret
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
–ü–æ–ª—è:
- `code` ‚Äî device_code –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è access token
- `user_code` ‚Äî –∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `verification_uri` ‚Äî URL, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `user_code`
- `expires_in` ‚Äî –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ `code` (—Å–µ–∫.)
- `interval` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (—Å–µ–∫.)

–ü—Ä–∏–º–µ—Ä:
```json
{
  "code": "ab23lcdefg340g0jgfgji45jb",
  "user_code": "ASDFGH",
  "verification_uri": "https://kino.pub/device",
  "expires_in": 8600,
  "interval": 5
}
```

---

### 1.2 –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (polling)
–ü–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø—Ä–∏–≤—è–∑–∫—É, —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É `authorization_pending`.

**POST** `/oauth2/device`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `grant_type` = `device_token` (–æ–±—è–∑.)
- `client_id` (–æ–±—è–∑.)
- `client_secret` (–æ–±—è–∑.)
- `code` ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —à–∞–≥–∞ 1.1 (–æ–±—è–∑.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
POST https://api.service-kp.com/oauth2/device?grant_type=device_token&client_id=myclient&client_secret=mysecret&code=ab23lcdefg340g0jgfgji45jb
```

**–û—Ç–≤–µ—Ç 400 (–ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ)**
```json
{ "error": "authorization_pending" }
```

---

### 1.3 –ü–æ–ª—É—á–µ–Ω–∏–µ `access_token` + `refresh_token`
–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª `user_code` –Ω–∞ `verification_uri`, —Ç–æ—Ç –∂–µ polling-–∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200.

**POST** `/oauth2/device` (—Ç–æ—Ç –∂–µ, —á—Ç–æ –≤ 1.2)

**–û—Ç–≤–µ—Ç 200 (JSON)**
–ü–æ–ª—è:
- `access_token` ‚Äî —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ API
- `token_type` ‚Äî –æ–∂–∏–¥–∞–µ–º–æ `bearer`
- `expires_in` ‚Äî —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è access token (—Å–µ–∫.)
- `refresh_token` ‚Äî —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 1.5)
- `scope` ‚Äî ‚Äú–ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º‚Äù –≤ –¥–æ–∫–∞—Ö

–ü—Ä–∏–º–µ—Ä:
```json
{
  "access_token": "asdfghjkl123456789",
  "token_type": "bearer",
  "expires_in": 3600,
  "refresh_token": "qwertyu12345678",
  "scope": null
}
```

---

### 1.4 (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –°–æ–æ–±—â–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è `access_token` –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.

**POST** `/v1/device/notify`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑. –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (–∫–∞–∫ –ø–æ–ª—è)**
- `title` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `hardware` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∂–µ–ª–µ–∑—É
- `software` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–æ—Ñ—Ç—É

> –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –∫–∞–∫ ‚Äú–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞‚Äù, –Ω–æ –±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞, –≥–¥–µ –∏–º–µ–Ω–Ω–æ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è (body vs query).  
> –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å JSON-body **–∏** –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å `Content-Type: application/json`. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç form-urlencoded ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (–≤–∞—Ä–∏–∞–Ω—Ç —Å JSON body)**
```http
POST https://api.service-kp.com/v1/device/notify?access_token=ACCESS_TOKEN
Content-Type: application/json

{
  "title": "AppleTV Hall",
  "hardware": "AppleTV/5.3",
  "software": "iOS/8.3"
}
```

**–û—Ç–≤–µ—Ç 200**
```json
{ "status": 200 }
```

---

### 1.5 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `access_token` (refresh)
**POST** `/oauth2/token`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `grant_type` = `refresh_token` (–æ–±—è–∑.)
- `client_id` (–æ–±—è–∑.)
- `client_secret` (–æ–±—è–∑.)
- `refresh_token` (–æ–±—è–∑.)

**–í–∞–∂–Ω–æ –ø–æ semantics**
- `refresh_token` –≤–∞–ª–∏–¥–µ–Ω ~30 –¥–Ω–µ–π (–ø–æ –¥–æ–∫–∞–º).
- –ü–æ—Å–ª–µ refresh **—Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏** ‚Äî –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ atomically (—Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π `refresh_token`, –∑–∞—Ç–µ–º `access_token`).

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
POST https://api.service-kp.com/oauth2/token?grant_type=refresh_token&client_id=myclient&client_secret=mysecret&refresh_token=qwertyu12345678
```

**–û—Ç–≤–µ—Ç 200**
```json
{
  "access_token": "NEW_ACCESS_TOKEN",
  "token_type": "bearer",
  "expires_in": 3600,
  "refresh_token": "NEW_REFRESH_TOKEN"
}
```

---

## 2) –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (—Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ)

### 2.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ)
**GET** `/v1/history`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)
- `page` ‚Äî –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ–ø—Ü.)
- `perpage` ‚Äî —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20, –º–∞–∫—Å–∏–º—É–º 50 (–æ–ø—Ü.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/history?access_token=ACCESS_TOKEN&page=1&perpage=20
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
- `history[]` ‚Äî —ç–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏
- `pagination` ‚Äî –º–µ—Ç–∞ –ø–æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

–ü–æ–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏:
- `time` ‚Äî ‚Äú–≤—Ä–µ–º—è, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å‚Äù (—Å–µ–∫—É–Ω–¥–∞/–ø–æ–∑–∏—Ü–∏—è)
- `counter` ‚Äî —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–º–æ—Ç—Ä–µ–ª–∏ –¥–∞–Ω–Ω—ã–π `media`
- `first_seen` ‚Äî unixtime –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- `last_seen` ‚Äî unixtime –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- `item` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ item (—Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª/–∏ —Ç.–ø.)
- `media` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ media (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–ø–∏–∑–æ–¥/–≤–∏–¥–µ–æ-—é–Ω–∏—Ç)

–ü—Ä–∏–º–µ—Ä (—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, –∫–∞–∫ –≤ –¥–æ–∫–µ):
```json
{
  "history": [
    {
      "time": 123,
      "counter": 1,
      "first_seen": 12344545,
      "last_seen": 1234556,
      "item": {},
      "media": {}
    }
  ],
  "pagination": {
    "total": 123,
    "current": 1,
    "perpage": 20,
    "total_items": 123
  }
}
```

#### –ö–∞–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—É—á–∏—Ç—å ‚Äú—Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ‚Äù
- **–§–∏–ª—å–º—ã**: –±–µ—Ä—ë—Ç–µ `history[].item` –≥–¥–µ `type=movie` (–∏–ª–∏ –∏–Ω–æ–π ‚Äú–Ω–µ serial‚Äù —Ç–∏–ø –ø–æ –≤–∞—à–∏–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º), –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç–µ –ø–æ `item.id`.
- **–°–µ—Ä–∏–∞–ª—ã**: –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç–∞—ë—Ç–µ `item` —Å `type=serial`, –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç–µ –ø–æ `item.id` ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–∞–ª–æ–≤, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ —Å–º–æ—Ç—Ä–µ–ª.
- **–≠–ø–∏–∑–æ–¥—ã**: –≤ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—ã—á–Ω–æ –µ—Å—Ç—å –ø—Ä–∏–≤—è–∑–∫–∞ –∫ `media` (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–µ—Ä–∏—è/–≤–∏–¥–µ–æ). –î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äú—Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π‚Äù –º–æ–∂–Ω–æ:
  - –ª–∏–±–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å `history` –ø–æ `item.id` –∏ `media.id`,
  - –ª–∏–±–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ —Å–µ—Ä–∏–∞–ª—É —á–µ—Ä–µ–∑ `/v1/watching?id=<serial_id>`.

---

## 3) –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ —Å–µ—Ä–∏–∞–ª–∞–º/—ç–ø–∏–∑–æ–¥–∞–º (watching)

### 3.1 –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º –¥–ª—è —Ñ–∏–ª—å–º–∞/—Å–µ—Ä–∏–∞–ª–∞
**GET** `/v1/watching`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)
- `id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–∞/—Å–µ—Ä–∏–∞–ª–∞ (–æ–±—è–∑.)
- `video` ‚Äî –Ω–æ–º–µ—Ä –≤–∏–¥–µ–æ (–Ω–∞—á–∏–Ω–∞—è —Å 1). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤—ã–≤–æ–¥—è—Ç—Å—è –≤—Å–µ –≤–∏–¥–µ–æ (–æ–ø—Ü.)
- `season` ‚Äî –Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞ –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ (–Ω–∞—á–∏–Ω–∞—è —Å 1). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤—ã–≤–æ–¥—è—Ç—Å—è –≤—Å–µ —Å–µ–∑–æ–Ω—ã (–æ–ø—Ü.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/watching?access_token=ACCESS_TOKEN&id=123
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `item` —Å —Ä–∞–∑–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:
- –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤: `seasons[] -> episodes[]`
- –¥–ª—è —Ñ–∏–ª—å–º–æ–≤/–º–Ω–æ–≥–æ—Å–µ—Ä–∏–π–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ —Ç.–ø.: `videos[]`

–ü–æ–ª—è, –≤–∞–∂–Ω—ã–µ –¥–ª—è ‚Äú—Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ‚Äù:
- `status`: `-1` –Ω–µ —Å–º–æ—Ç—Ä–µ–ª–∏, `0` –Ω–∞—á–∞–ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å, `1` –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏
- `time`: –ø–æ–∑–∏—Ü–∏—è, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
- `updated`: timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

–ü—Ä–∏–º–µ—Ä (—Å–µ—Ä–∏–∞–ª):
```json
{
  "status": 200,
  "item": {
    "id": 123,
    "title": "Item title",
    "type": "serial",
    "seasons": [
      {
        "id": 432,
        "number": 1,
        "status": 0,
        "episodes": [
          {
            "id": 4567,
            "number": 1,
            "title": "Episode title",
            "duration": 1234,
            "time": 0,
            "status": 1,
            "updated": 123456782
          }
        ]
      }
    ]
  }
}
```

–ü—Ä–∏–º–µ—Ä (—Ñ–∏–ª—å–º/–º–Ω–æ–≥–æ—Å–µ—Ä–∏–π–Ω—ã–π —Ñ–∏–ª—å–º):
```json
{
  "status": 200,
  "item": {
    "id": 123,
    "title": "Item title",
    "type": "movie",
    "videos": [
      {
        "id": 1234,
        "number": 1,
        "title": "Video title",
        "duration": 1234,
        "time": 123,
        "status": 1,
        "updated": 123456782
      }
    ]
  }
}
```

---

### 3.2 –ù–µ–¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã/–∫–æ–Ω—Ü–µ—Ä—Ç—ã/–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ/3D
**GET** `/v1/watching/movies`

> –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–ª–µ–∑–µ–Ω, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äú–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä‚Äù, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è ‚Äú–∏—Å—Ç–æ—Ä–∏–∏‚Äù (–æ–Ω–∞ –µ—Å—Ç—å –≤ `/v1/history`).

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/watching/movies?access_token=ACCESS_TOKEN
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
```json
{
  "status": 200,
  "items": [
    {
      "id": 123,
      "type": "movie",
      "subtype": "",
      "title": "–ù–∞–∑–≤–∞–Ω–∏–µ",
      "posters": {
        "small": "http://url.to/small_poster.jpg",
        "medium": "http://url.to/medium_poster.jpg",
        "big": "http://url.to/big_poster.jpg"
      }
    }
  ]
}
```

---

### 3.3 –°–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–∞–ª–æ–≤ —Å –Ω–æ–≤—ã–º–∏/–Ω–µ–¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–∏—è–º–∏
**GET** `/v1/watching/serials`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)
- `subscribed` ‚Äî `0/1` (–æ–ø—Ü.)
  - `0`: –≤—Å–µ –Ω–µ–¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∞–ª—ã
  - `1`: —Ç–æ–ª—å–∫–æ —Å–µ—Ä–∏–∞–ª—ã –∏–∑ ‚Äú–ë—É–¥—É —Å–º–æ—Ç—Ä–µ—Ç—å‚Äù

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/watching/serials?access_token=ACCESS_TOKEN&subscribed=0
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
```json
{
  "status": 200,
  "items": [
    {
      "id": 123,
      "type": "serial",
      "subtype": "",
      "title": "–ù–∞–∑–≤–∞–Ω–∏–µ",
      "posters": {
        "small": "http://url.to/small_poster.jpg",
        "medium": "http://url.to/medium_poster.jpg",
        "big": "http://url.to/big_poster.jpg"
      },
      "total": 10,
      "watched": 5,
      "new": 5
    }
  ]
}
```

---

## 4) –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ —Ñ–∏–ª—å–º–∞–º –∏ —Å–µ—Ä–∏–∞–ª–∞–º (–Ω–∞–∑–≤–∞–Ω–∏–µ, –ø–æ—Å—Ç–µ—Ä, imdb –∏ –¥—Ä.)

–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –≤–∞–º –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:
- **—Å–ø–∏—Å–∫–∞** `/v1/items` (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ª–µ–Ω—Ç–∞/–∫–∞—Ç–∞–ª–æ–≥)  
- **–ø–æ–∏—Å–∫–∞** `/v1/items/search` (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–∏—Å–∫)
- **–¥–µ—Ç–∞–ª–µ–π** `/v1/items/<item-id>` (–∫–æ–≥–¥–∞ –µ—Å—Ç—å `item.id` –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏/–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)

### 4.1 –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
**GET** `/v1/items`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å–∞–º—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É)**
- `access_token` (–æ–±—è–∑.)
- `type` ‚Äî —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `movie`, `serial`)
- `title` ‚Äî –ø–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞, LIKE)
- `sort` ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `updated-`), –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `id,year,title,created,updated,rating,views,watchers`
- (–µ—Å—Ç—å –º–Ω–æ–≥–æ –¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä–æ–≤: `genre`, `country`, `year`, `finished`, `actor`, `director`, –∏ —Ç.–¥.)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–∏–∞–ª—ã)**
```http
GET https://api.service-kp.com/v1/items?access_token=ACCESS_TOKEN&type=serial&sort=updated-
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
–í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è:
- `items[]` ‚Äî —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ç–∞–ª–æ–≥–∞
- `pagination` ‚Äî –º–µ—Ç–∞ –ø–æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (`total`, `current`, `perpage`)

–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä—è–º–æ –≤–∏–¥–Ω—ã –≤ –ø—Ä–∏–º–µ—Ä–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
- `id`
- `title`
- `type`, `subtype`
- `year`
- `posters.small|medium|big`
- `trailer.id`, `trailer.url`
- `imdb` (–Ω–∞–ø—Ä–∏–º–µ—Ä `tt...`)
- `kinopoisk` (—á–∏—Å–ª–æ–≤–æ–π id)
- + —Ä—è–¥ –¥–æ–ø. –ø–æ–ª–µ–π (cast/director/voice, —Ä–µ–π—Ç–∏–Ω–≥–∏ –∏ —Ç.–¥.)

–ü—Ä–∏–º–µ—Ä (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ):
```json
{
  "items": [
    {
      "id": 1,
      "title": "–ù–∞–∑–≤–∞–Ω–∏–µ / –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
      "type": "movie",
      "subtype": "multi",
      "year": 2006,
      "cast": "–ê–∫—Ç—ë—Ä 1, –ê–∫—Ç—ë—Ä 2",
      "director": "–†–µ–∂–∏—Å—Å—ë—Ä 1, –†–µ–∂–∏—Å—Å—ë—Ä 2",
      "rating": 7.1,
      "imdb": "tt6432180",
      "kinopoisk": 123,
      "posters": {
        "small": "http://kino.pub/media/poster/item/small/1.jpg",
        "medium": "http://kino.pub/media/poster/item/medium/1.jpg",
        "big": "http://kino.pub/media/poster/item/big/1.jpg"
      },
      "trailer": {
        "id": "udNj459jn",
        "url": "http://www.youtube.com/watch?v=udNj459jn"
      }
    }
  ],
  "pagination": {
    "total": 1,
    "current": 1,
    "perpage": 1
  }
}
```

---

### 4.2 –ü–æ–∏—Å–∫ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
**GET** `/v1/items/search`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)
- `q` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ (–æ–±—è–∑.)
- `type` ‚Äî —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–ø—Ü.)
- `field` ‚Äî –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ: `title|director|cast` (–æ–ø—Ü.)
- `perpage` ‚Äî –∫–æ–ª-–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 40)
- `sectioned` ‚Äî `0/1` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0). –ï—Å–ª–∏ `1`, –æ—Ç–≤–µ—Ç –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç—Å—è –ø–æ `type`.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/items/search?access_token=ACCESS_TOKEN&q=terminator&type=movie&perpage=40
```

**–û—Ç–≤–µ—Ç (–±–µ–∑ `sectioned`)**
```json
{
  "status": 200,
  "items": [],
  "pagination": {}
}
```

---

### 4.3 –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ item (—Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª)
**GET** `/v1/items/<item-id>`

**Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- `access_token` (–æ–±—è–∑.)
- `nolinks` ‚Äî `1` —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å ‚Äú—Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ‚Äù –∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –æ—Ç–≤–µ—Ç (–æ—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–µ—Ä–∏–∞–ª–æ–≤).

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```http
GET https://api.service-kp.com/v1/items/123?access_token=ACCESS_TOKEN&nolinks=1
```

**–û—Ç–≤–µ—Ç 200 (JSON)**
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞, –Ω–æ –≤ —Ü–µ–ª–æ–º:
- `item` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –ø–æ—Å—Ç–µ—Ä—ã, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, –∏ —Ç.–¥.)
- `videos` (–¥–ª—è movie) –∏–ª–∏ `seasons`/`episodes` (–¥–ª—è serial) ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–¥–∏–∞–∫–æ–Ω—Ç–µ–Ω—Ç–∞
- —Ç–∞–∫–∂–µ –º–æ–≥—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–ª—è ‚Äúwatched/watching‚Äù –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–∏–¥–µ–æ/—ç–ø–∏–∑–æ–¥–æ–≤

> –î–ª—è –≤–∞—à–µ–π –∑–∞–¥–∞—á–∏ ‚Äú–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ‚Äù –ø—Ä–æ—â–µ –∏ –¥–µ—à–µ–≤–ª–µ –±—Ä–∞—Ç—å –∏–∑ `item`, –∞ ‚Äú—á—Ç–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ‚Äù ‚Äî –∏–∑ `/v1/watching`.

---

## 5) –ò—Ç–æ–≥: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –ø–æ–¥ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤)
- `POST /oauth2/device?grant_type=device_code&client_id=...&client_secret=...`
- `POST /oauth2/device?grant_type=device_token&client_id=...&client_secret=...&code=...`

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- `POST /oauth2/token?grant_type=refresh_token&client_id=...&client_secret=...&refresh_token=...`

### –ò—Å—Ç–æ—Ä–∏—è / –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–µ
- `GET /v1/history?access_token=...&page=...&perpage=...`  ‚Üê –±–∞–∑–æ–≤–∞—è ‚Äú–∏—Å—Ç–æ—Ä–∏—è‚Äù
- `GET /v1/watching?access_token=...&id=...`              ‚Üê –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–µ—Ä–∏–∞–ª—É/—ç–ø–∏–∑–æ–¥–∞–º (–∏ —Ñ–∏–ª—å–º–∞–º)
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `GET /v1/watching/movies?access_token=...` ‚Üê ‚Äú–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä‚Äù
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `GET /v1/watching/serials?access_token=...&subscribed=...` ‚Üê –Ω–µ–¥–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ/–Ω–æ–≤—ã–µ —Å–µ—Ä–∏–∞–ª—ã

### –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ —Ñ–∏–ª—å–º–∞—Ö/—Å–µ—Ä–∏–∞–ª–∞—Ö
- `GET /v1/items?access_token=...`                        ‚Üê –∫–∞—Ç–∞–ª–æ–≥/—Å–ø–∏—Å–æ–∫ (–≤–∫–ª—é—á–∞—è imdb –∏ –ø–æ—Å—Ç–µ—Ä—ã)
- `GET /v1/items/search?access_token=...&q=...`           ‚Üê –ø–æ–∏—Å–∫
- `GET /v1/items/<item-id>?access_token=...&nolinks=1`    ‚Üê –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É item

### (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –Ω–æ –Ω–µ —Å—Ç—Ä–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `POST /v1/device/notify?access_token=...`               ‚Üê —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

---